{% extends 'base.html' %}

{% block title %}
{% if object %}Edit Sale #{{ object.id }}{% else %}New Sale{% endif %}
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="mb-3">
        <a href="{% url 'sales:list' %}" class="text-gray-500 hover:text-gray-700 text-sm flex items-center mb-1">
            <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Back to Sales
        </a>
        <h1 class="text-lg sm:text-2xl font-bold text-gray-800">
            {% if object %}Edit Sale #{{ object.id }}{% else %}New Sale{% endif %}
        </h1>
    </div>

    <div class="bg-white shadow rounded-lg overflow-hidden">
        <form method="post" class="p-4 sm:p-6 space-y-4" id="sale-form">
            {% csrf_token %}

            {% if form.non_field_errors %}
            <div class="bg-red-50 text-red-700 p-3 rounded-md border border-red-200 text-sm">
                {% for error in form.non_field_errors %}{{ error }}{% endfor %}
            </div>
            {% endif %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                <!-- Customer Section -->
                <div class="md:col-span-2 space-y-1 relative">
                    <label for="{{ form.customer_name.id_for_label }}"
                        class="block text-sm font-medium text-gray-700">Customer Name <span
                            class="text-red-500">*</span></label>
                    {{ form.customer_name }}
                    <div id="customer-results"
                        class="absolute z-10 w-full mt-1 bg-white shadow-lg rounded-md overflow-hidden"
                        onclick="if(event.target.tagName==='DIV'){ document.getElementById('{{ form.customer_name.id_for_label }}').value = event.target.innerText; this.innerHTML = ''; }">
                    </div>
                    {% if form.customer_name.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.customer_name.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Product Section -->
                <div class="col-span-1 space-y-1">
                    <label for="{{ form.batch.id_for_label }}" class="block text-sm font-medium text-gray-700">Batch
                        (Source)</label>
                    <select name="{{ form.batch.name }}" id="{{ form.batch.id_for_label }}"
                        class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 bg-white">
                        {% for x, y in form.fields.batch.choices %}
                        <option value="{{ x }}" {% if form.batch.value|stringformat:"s" == x|stringformat:"s" %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-span-1 space-y-1">
                    <label for="{{ form.bottle_type.id_for_label }}"
                        class="block text-sm font-medium text-gray-700">Bottle Size</label>
                    <select name="{{ form.bottle_type.name }}" id="{{ form.bottle_type.id_for_label }}"
                        class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 bg-white">
                        {% for x, y in form.fields.bottle_type.choices %}
                        <option value="{{ x }}" {% if form.bottle_type.value == x %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Pricing Section -->
                <div class="col-span-1 space-y-1">
                    <label for="{{ form.unit_price.id_for_label }}" class="block text-sm font-medium text-gray-700">Unit
                        Price (₦)</label>
                    <input type="text" inputmode="decimal" name="{{ form.unit_price.name }}"
                        id="{{ form.unit_price.id_for_label }}" value="{{ form.unit_price.value|default:'' }}"
                        class="currency-input mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2">
                </div>

                <div class="col-span-1 space-y-1">
                    <label for="{{ form.quantity.id_for_label }}"
                        class="block text-sm font-medium text-gray-700">Quantity</label>
                    <input type="text" inputmode="numeric" name="{{ form.quantity.name }}" id="{{ form.quantity.id_for_label }}"
                        value="{{ form.quantity.value|default:'' }}"
                        class="quantity-input mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2">
                </div>

                <!-- Total Display -->
                <div
                    class="md:col-span-2 bg-gray-50 p-3 rounded-md flex justify-between items-center border border-gray-200">
                    <span class="text-xs sm:text-sm font-medium text-gray-500 uppercase tracking-wide">Estimated Total</span>
                    <span id="total-price-display" class="text-xl sm:text-2xl font-bold text-indigo-600">₦0.00</span>
                </div>

                <!-- Additional Info -->
                <div class="col-span-1 space-y-1">
                    <label for="{{ form.payment_status.id_for_label }}"
                        class="block text-sm font-medium text-gray-700">Initial Payment Status</label>
                    <select name="{{ form.payment_status.name }}" id="{{ form.payment_status.id_for_label }}"
                        class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 bg-white">
                        {% for x, y in form.fields.payment_status.choices %}
                        <option value="{{ x }}" {% if form.payment_status.value == x %}selected{% endif %}>{{ y }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-span-1 flex items-center pt-4">
                    <div class="flex items-center h-5">
                        <input id="{{ form.is_wholesale.id_for_label }}" name="{{ form.is_wholesale.name }}"
                            type="checkbox" {% if form.is_wholesale.value %}checked{% endif %}
                            class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                    </div>
                    <div class="ml-3 text-sm">
                        <label for="{{ form.is_wholesale.id_for_label }}" class="font-medium text-gray-700">Wholesale
                            Transaction</label>
                    </div>
                </div>

                <div class="md:col-span-2 space-y-1">
                    <label for="{{ form.notes.id_for_label }}" class="block text-sm font-medium text-gray-700">Notes /
                        Instructions</label>
                    {{ form.notes }}
                </div>
            </div>

            <div class="pt-5 flex justify-end">
                <a href="{% url 'sales:list' %}"
                    class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mr-3">
                    Cancel
                </a>
                <button type="submit"
                    class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    {% if object %}Update Sale{% else %}Record Sale{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Initial calculation on page load
    document.addEventListener('DOMContentLoaded', function () {
        const unitPriceInput = document.getElementById('{{ form.unit_price.id_for_label }}');
        const quantityInput = document.getElementById('{{ form.quantity.id_for_label }}');

        // Trigger generic calculation function from main.js
        if (unitPriceInput && quantityInput) {
            unitPriceInput.dispatchEvent(new Event('input'));
        }
    });
</script>
{% endblock %}